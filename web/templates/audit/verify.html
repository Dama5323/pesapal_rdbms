{% extends 'base.html' %}

{% block title %}Audit & Verification - PesaPal RDBMS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-0">Audit & Verification</h1>
        <p class="text-muted">Verify ledger integrity and audit transactions</p>
    </div>
</div>

<!-- Verification Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Total Ledger Entries</h6>
                        <h2 class="stat-number mb-0">{{ total_ledgers }}</h2>
                    </div>
                    <div class="card-icon bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-journal-text"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Verified Entries</h6>
                        <h2 class="stat-number mb-0">{{ verified_count }}</h2>
                    </div>
                    <div class="card-icon bg-success bg-opacity-10 text-success">
                        <i class="bi bi-shield-check"></i>
                    </div>
                </div>
                <div class="mt-3">
                    <span class="text-success">
                        {{ verification_percentage }}% verified
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-warning border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Pending Verification</h6>
                        <h2 class="stat-number mb-0">{{ pending_count }}</h2>
                    </div>
                    <div class="card-icon bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-danger border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Failed Verification</h6>
                        <h2 class="stat-number mb-0">{{ failed_count }}</h2>
                    </div>
                    <div class="card-icon bg-danger bg-opacity-10 text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Verification Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check me-2"></i> Verification Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <form method="post" action="{% url 'audit' %}">
                            {% csrf_token %}
                            <input type="hidden" name="verify_all" value="true">
                            <button type="submit" class="btn btn-primary w-100 py-3">
                                <i class="bi bi-check-circle me-2"></i>
                                <div class="fw-bold">Verify All Ledgers</div>
                                <small class="d-block">Check integrity of all ledger entries</small>
                            </button>
                        </form>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-success w-100 py-3" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            <div class="fw-bold">Generate Audit Report</div>
                            <small class="d-block">Create comprehensive audit report</small>
                        </button>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-warning w-100 py-3" data-bs-toggle="modal" data-bs-target="#compareLedgersModal">
                            <i class="bi bi-arrow-left-right me-2"></i>
                            <div class="fw-bold">Compare Ledgers</div>
                            <small class="d-block">Compare two ledger states</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Verification Results -->
{% if verification_results %}
<div class="row">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i> Verification Results
                </h5>
                <span class="badge bg-{{ overall_status }}">
                    {{ overall_status_message }}
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ledger ID</th>
                                <th>Transaction ID</th>
                                <th>Timestamp</th>
                                <th>Status</th>
                                <th>Hash Match</th>
                                <th>Previous Hash</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in verification_results %}
                            <tr>
                                <td>
                                    <code class="text-primary">{{ result.ledger.id|truncatechars:10 }}</code>
                                </td>
                                <td>
                                    <code>{{ result.ledger.transaction.transaction_id|truncatechars:12 }}</code>
                                </td>
                                <td>{{ result.ledger.timestamp|date:"Y-m-d H:i:s" }}</td>
                                <td>
                                    <span class="status-badge status-{{ result.ledger.status }}">
                                        {{ result.ledger.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if result.is_valid %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i> Valid
                                    </span>
                                    {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle me-1"></i> Invalid
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <code class="text-muted" title="{{ result.ledger.previous_hash }}">
                                        {{ result.ledger.previous_hash|truncatechars:10 }}
                                    </code>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" 
                                            data-bs-target="#ledgerModal{{ result.ledger.id }}">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            
                            <!-- Modal for ledger details -->
                            <div class="modal fade" id="ledgerModal{{ result.ledger.id }}" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Ledger Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6>Ledger Information</h6>
                                                    <dl class="row">
                                                        <dt class="col-sm-4">Ledger ID:</dt>
                                                        <dd class="col-sm-8"><code>{{ result.ledger.id }}</code></dd>
                                                        
                                                        <dt class="col-sm-4">Transaction:</dt>
                                                        <dd class="col-sm-8"><code>{{ result.ledger.transaction.transaction_id }}</code></dd>
                                                        
                                                        <dt class="col-sm-4">Timestamp:</dt>
                                                        <dd class="col-sm-8">{{ result.ledger.timestamp|date:"Y-m-d H:i:s" }}</dd>
                                                        
                                                        <dt class="col-sm-4">Status:</dt>
                                                        <dd class="col-sm-8">
                                                            <span class="badge bg-{{ result.ledger.status }}">
                                                                {{ result.ledger.get_status_display }}
                                                            </span>
                                                        </dd>
                                                    </dl>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6>Hash Information</h6>
                                                    <dl class="row">
                                                        <dt class="col-sm-4">Stored Hash:</dt>
                                                        <dd class="col-sm-8">
                                                            <code class="small">{{ result.ledger.data_hash }}</code>
                                                        </dd>
                                                        
                                                        <dt class="col-sm-4">Previous Hash:</dt>
                                                        <dd class="col-sm-8">
                                                            <code class="small">{{ result.ledger.previous_hash }}</code>
                                                        </dd>
                                                        
                                                        <dt class="col-sm-4">Verification:</dt>
                                                        <dd class="col-sm-8">
                                                            {% if result.is_valid %}
                                                            <span class="badge bg-success">Hash Verified</span>
                                                            {% else %}
                                                            <span class="badge bg-danger">Hash Mismatch</span>
                                                            {% endif %}
                                                        </dd>
                                                        
                                                        <dt class="col-sm-4">Message:</dt>
                                                        <dd class="col-sm-8">{{ result.message }}</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <h6>Transaction Details</h6>
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <pre class="mb-0"><code>{{ transaction_details|safe }}</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            {% if not result.is_valid %}
                                            <button type="button" class="btn btn-danger">
                                                <i class="bi bi-exclamation-triangle me-2"></i> Flag Issue
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card dashboard-card">
            <div class="card-body text-center py-5">
                <div class="text-muted mb-3">
                    <i class="bi bi-shield display-4"></i>
                </div>
                <h5 class="mb-3">No Verification Results Yet</h5>
                <p class="text-muted mb-4">
                    Run a verification to check the integrity of your ledger entries.
                </p>
                <form method="post" action="{% url 'audit' %}">
                    {% csrf_token %}
                    <input type="hidden" name="verify_all" value="true">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-shield-check me-2"></i> Run First Verification
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modals -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Audit Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select class="form-select" id="reportType">
                            <option value="full">Full Audit Report</option>
                            <option value="verification">Verification Summary</option>
                            <option value="integrity">Integrity Check Report</option>
                            <option value="compliance">Compliance Report</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dateRange" class="form-label">Date Range</label>
                        <select class="form-select" id="dateRange">
                            <option value="all">All Time</option>
                            <option value="month">Last 30 Days</option>
                            <option value="week">Last 7 Days</option>
                            <option value="today">Today</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="format" class="form-label">Output Format</label>
                        <select class="form-select" id="format">
                            <option value="pdf">PDF Document</option>
                            <option value="csv">CSV Spreadsheet</option>
                            <option value="json">JSON Data</option>
                            <option value="html">HTML Report</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="generateReport()">
                    <i class="bi bi-download me-2"></i> Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="compareLedgersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compare Ledger States</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="compareForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="ledgerState1" class="form-label">First Ledger State</label>
                            <select class="form-select" id="ledgerState1">
                                <option value="">Select date/time...</option>
                                <option value="latest">Latest State</option>
                                <option value="yesterday">Yesterday (EOD)</option>
                                <option value="week_ago">One Week Ago</option>
                                <option value="month_ago">One Month Ago</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ledgerState2" class="form-label">Second Ledger State</label>
                            <select class="form-select" id="ledgerState2">
                                <option value="">Select date/time...</option>
                                <option value="latest" selected>Latest State</option>
                                <option value="yesterday">Yesterday (EOD)</option>
                                <option value="week_ago">One Week Ago</option>
                                <option value="month_ago">One Month Ago</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="comparisonType" class="form-label">Comparison Type</label>
                        <select class="form-select" id="comparisonType">
                            <option value="full">Full Comparison</option>
                            <option value="differences">Only Differences</option>
                            <option value="additions">Only Additions</option>
                            <option value="deletions">Only Deletions</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="compareLedgers()">
                    <i class="bi bi-arrow-left-right me-2"></i> Compare
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function generateReport() {
        const reportType = document.getElementById('reportType').value;
        const dateRange = document.getElementById('dateRange').value;
        const format = document.getElementById('format').value;
        
        // Show loading
        showLoading('Generating report...');
        
        // Simulate API call
        setTimeout(() => {
            hideLoading();
            alert(`Report generation started!\nType: ${reportType}\nRange: ${dateRange}\nFormat: ${format}\n\nReport will be available for download shortly.`);
            $('#generateReportModal').modal('hide');
        }, 1500);
    }
    
    function compareLedgers() {
        const state1 = document.getElementById('ledgerState1').value;
        const state2 = document.getElementById('ledgerState2').value;
        const type = document.getElementById('comparisonType').value;
        
        if (!state1 || !state2) {
            alert('Please select both ledger states to compare.');
            return;
        }
        
        if (state1 === state2) {
            alert('Please select two different ledger states for comparison.');
            return;
        }
        
        // Show loading
        showLoading('Comparing ledger states...');
        
        // Simulate comparison
        setTimeout(() => {
            hideLoading();
            alert(`Comparison started!\nState 1: ${state1}\nState 2: ${state2}\nType: ${type}\n\nResults will be displayed shortly.`);
            $('#compareLedgersModal').modal('hide');
            
            // Redirect to comparison results page (simulated)
            window.location.href = '/audit/compare-results/';
        }, 1500);
    }
    
    function showLoading(message) {
        // Create loading overlay
        const overlay = document.createElement('div');
        overlay.id = 'loadingOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        
        overlay.innerHTML = `
            <div class="text-center bg-white p-4 rounded-3">
                <div class="spinner-border text-primary mb-3"></div>
                <div class="fw-bold">${message}</div>
            </div>
        `;
        
        document.body.appendChild(overlay);
    }
    
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
</script>
{% endblock %}