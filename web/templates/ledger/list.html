{% extends 'base.html' %}

{% block title %}Immutable Ledger - PesaPal RDBMS{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2 mb-0">Immutable Ledger</h1>
        <p class="text-muted">View all cryptographically secured ledger entries</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addLedgerModal">
            <i class="bi bi-plus-circle me-2"></i> Add Ledger Entry
        </button>
    </div>
</div>

<!-- Ledger Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-primary border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Total Entries</h6>
                        <h2 class="stat-number mb-0">{{ total_ledgers|default:"0" }}</h2>
                    </div>
                    <div class="card-icon bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-journal-text"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-success border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Verified</h6>
                        <h2 class="stat-number mb-0">{{ verified_count|default:"0" }}</h2>
                    </div>
                    <div class="card-icon bg-success bg-opacity-10 text-success">
                        <i class="bi bi-shield-check"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-warning border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Chain Integrity</h6>
                        <h2 class="stat-number mb-0">{{ chain_integrity|default:"0" }}%</h2>
                    </div>
                    <div class="card-icon bg-warning bg-opacity-10 text-warning">
                        <i class="bi bi-link-45deg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card dashboard-card border-start border-info border-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-2">Last Updated</h6>
                        <h2 class="stat-number mb-0" id="lastUpdateTime">Just now</h2>
                    </div>
                    <div class="card-icon bg-info bg-opacity-10 text-info">
                        <i class="bi bi-clock-history"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card dashboard-card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Status</option>
                    <option value="verified">Verified</option>
                    <option value="pending">Pending</option>
                    <option value="invalid">Invalid</option>
                </select>
            </div>
            <div class="col-md-5">
                <label class="form-label">Search</label>
                <div class="input-group">
                    <input type="text" name="search" class="form-control" 
                           placeholder="Search by ID, hash, or description...">
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <input type="date" class="form-control" name="date">
            </div>
        </form>
    </div>
</div>

<!-- Ledger Table -->
<div class="card dashboard-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Ledger ID</th>
                        <th>Timestamp</th>
                        <th>Data Hash</th>
                        <th>Previous Hash</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ledger in ledgers %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <code class="text-primary" title="{{ ledger.id }}">
                                {{ ledger.id|truncatechars:10|default:"N/A" }}
                            </code>
                        </td>
                        <td>{{ ledger.timestamp|date:"Y-m-d H:i:s"|default:"N/A" }}</td>
                        <td>
                            <code class="text-muted" title="{{ ledger.data_hash|default:'' }}">
                                {{ ledger.data_hash|truncatechars:12|default:"N/A" }}
                            </code>
                        </td>
                        <td>
                            <code class="text-muted" title="{{ ledger.previous_hash|default:'' }}">
                                {{ ledger.previous_hash|truncatechars:12|default:"N/A" }}
                            </code>
                        </td>
                        <td>
                            {% if ledger.is_verified %}
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle me-1"></i> Verified
                            </span>
                            {% else %}
                            <span class="badge bg-warning">
                                <i class="bi bi-clock me-1"></i> Pending
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" data-bs-toggle="modal" 
                                        data-bs-target="#viewLedgerModal{{ forloop.counter }}">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="verifyLedger('{{ ledger.id|default:"" }}')">
                                    <i class="bi bi-shield-check"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="exportLedger('{{ ledger.id|default:"" }}')">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    
                    <!-- View Ledger Modal -->
                    <div class="modal fade" id="viewLedgerModal{{ forloop.counter }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Ledger Entry Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Basic Information</h6>
                                            <dl class="row">
                                                <dt class="col-sm-4">Ledger ID:</dt>
                                                <dd class="col-sm-8"><code>{{ ledger.id|default:"N/A" }}</code></dd>
                                                
                                                <dt class="col-sm-4">Timestamp:</dt>
                                                <dd class="col-sm-8">{{ ledger.timestamp|date:"Y-m-d H:i:s"|default:"N/A" }}</dd>
                                                
                                                <dt class="col-sm-4">Status:</dt>
                                                <dd class="col-sm-8">
                                                    {% if ledger.is_verified %}
                                                    <span class="badge bg-success">Verified</span>
                                                    {% else %}
                                                    <span class="badge bg-warning">Pending Verification</span>
                                                    {% endif %}
                                                </dd>
                                            </dl>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Hash Information</h6>
                                            <dl class="row">
                                                <dt class="col-sm-4">Data Hash:</dt>
                                                <dd class="col-sm-8">
                                                    <code class="small">{{ ledger.data_hash|default:"N/A" }}</code>
                                                </dd>
                                                
                                                <dt class="col-sm-4">Previous Hash:</dt>
                                                <dd class="col-sm-8">
                                                    <code class="small">{{ ledger.previous_hash|default:"N/A" }}</code>
                                                </dd>
                                                
                                                <dt class="col-sm-4">Chain Position:</dt>
                                                <dd class="col-sm-8">
                                                    <span class="badge bg-info">Entry {{ forloop.counter }}</span>
                                                </dd>
                                            </dl>
                                        </div>
                                    </div>
                                    
                                    {% if ledger.data %}
                                    <div class="mt-4">
                                        <h6>Ledger Data</h6>
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <pre class="mb-0"><code>{{ ledger.data|default:"{}" }}</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="exportLedger('{{ ledger.id|default:"" }}')">
                                        <i class="bi bi-download me-2"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-journal display-4 d-block mb-3"></i>
                                No ledger entries found
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if ledgers.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    {% if ledgers.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ ledgers.previous_page_number }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for num in ledgers.paginator.page_range %}
                        {% if ledgers.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > ledgers.number|add:'-3' and num < ledgers.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if ledgers.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ ledgers.next_page_number }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ ledgers.paginator.num_pages }}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Ledger Modal -->
<div class="modal fade" id="addLedgerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Ledger Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Ledger entry creation is coming soon.</p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    This feature will allow you to manually add ledger entries for auditing purposes.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" disabled>
                    <i class="bi bi-plus-circle me-2"></i> Coming Soon
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = 
                now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // Initialize
        updateLastUpdateTime();
        
        // Auto-update every minute
        setInterval(updateLastUpdateTime, 60000);
    });
    
    function verifyLedger(ledgerId) {
        if (!ledgerId) {
            alert('Ledger ID is required');
            return;
        }
        
        alert(`Verifying ledger ${ledgerId}...\n\nThis feature is coming soon.`);
    }
    
    function exportLedger(ledgerId) {
        if (!ledgerId) {
            alert('Ledger ID is required');
            return;
        }
        
        alert(`Exporting ledger ${ledgerId}...\n\nThis feature is coming soon.`);
    }
</script>
{% endblock %} 
{% extends 'base.html' %}

{% block title %}Register - PesaPal RDBMS{% endblock %}

{% block content %}